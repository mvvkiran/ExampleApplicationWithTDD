<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QuoteServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Auto Insurance API</a> &gt; <a href="index.source.html" class="el_package">com.autoinsurance.quote.service</a> &gt; <span class="el_source">QuoteServiceImpl.java</span></div><h1>QuoteServiceImpl.java</h1><pre class="source lang-java linenums">package com.autoinsurance.quote.service;

import com.autoinsurance.quote.dto.QuoteRequestDto;
import com.autoinsurance.quote.dto.QuoteResponseDto;
import com.autoinsurance.quote.entity.Quote;
import com.autoinsurance.quote.exception.QuoteNotFoundException;
import com.autoinsurance.quote.repository.QuoteRepository;
import com.autoinsurance.quote.service.validation.QuoteValidationService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.cache.annotation.Cacheable;
import org.springframework.cache.annotation.CacheEvict;
import org.springframework.cache.annotation.CachePut;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.util.List;

/**
 * Implementation of QuoteService providing core quote management functionality.
 * Handles quote generation, retrieval, and premium calculations with comprehensive
 * validation and error handling.
 */
@Service
public class QuoteServiceImpl implements QuoteService {

<span class="fc" id="L28">    private static final Logger log = LoggerFactory.getLogger(QuoteServiceImpl.class);</span>
    
    private final QuoteRepository quoteRepository;
    private final RiskCalculationService riskCalculationService;
    private final DiscountService discountService;
    private final QuoteValidationService validationService;
    private final QuoteEntityBuilderInterface quoteEntityBuilder;
    
<span class="fc" id="L36">    public QuoteServiceImpl(QuoteRepository quoteRepository, </span>
                           RiskCalculationService riskCalculationService,
                           DiscountService discountService,
                           QuoteValidationService validationService,
                           QuoteEntityBuilderInterface quoteEntityBuilder) {
<span class="fc" id="L41">        this.quoteRepository = quoteRepository;</span>
<span class="fc" id="L42">        this.riskCalculationService = riskCalculationService;</span>
<span class="fc" id="L43">        this.discountService = discountService;</span>
<span class="fc" id="L44">        this.validationService = validationService;</span>
<span class="fc" id="L45">        this.quoteEntityBuilder = quoteEntityBuilder;</span>
<span class="fc" id="L46">    }</span>

    @Override
    public QuoteResponseDto generateQuote(QuoteRequestDto request) {
<span class="fc" id="L50">        log.info(&quot;Starting quote generation process&quot;);</span>
        
        // Validate request
<span class="fc" id="L53">        validationService.validateQuoteRequest(request);</span>
        
        // Log validation success with key identifiers
<span class="fc" id="L56">        String vin = request.getVehicle().getVin();</span>
<span class="fc" id="L57">        String primaryDriverName = getPrimaryDriverName(request);</span>
<span class="fc" id="L58">        log.debug(&quot;Quote validation successful for vehicle VIN: {} and primary driver: {}&quot;, </span>
<span class="fc" id="L59">                 vin, primaryDriverName);</span>
        
        try {
            // Calculate premium components
<span class="fc" id="L63">            PremiumCalculation premiumCalc = calculatePremiumComponents(request);</span>
            
            // Create and save quote entity
<span class="fc" id="L66">            Quote quote = createQuoteEntity(request, premiumCalc);</span>
<span class="fc" id="L67">            Quote savedQuote = quoteRepository.save(quote);</span>
            
            // Build response
<span class="fc" id="L70">            QuoteResponseDto response = buildQuoteResponse(savedQuote, premiumCalc);</span>
            
<span class="fc" id="L72">            log.info(&quot;Quote successfully generated with ID: {}, premium: {}, VIN: {}&quot;, </span>
<span class="fc" id="L73">                    savedQuote.getId(), premiumCalc.getFinalPremium(), vin);</span>
            
<span class="fc" id="L75">            return response;</span>
            
<span class="fc" id="L77">        } catch (Exception ex) {</span>
<span class="fc" id="L78">            log.error(&quot;Failed to generate quote for VIN: {} and driver: {}. Error: {}&quot;, </span>
<span class="fc" id="L79">                     vin, primaryDriverName, ex.getMessage(), ex);</span>
<span class="fc" id="L80">            throw ex;</span>
        }
    }

    @Override
    @Cacheable(value = &quot;quoteCache&quot;, key = &quot;#id&quot;, unless = &quot;#result == null&quot;)
    public QuoteResponseDto getQuoteById(String id) {
<span class="fc" id="L87">        log.debug(&quot;Retrieving quote with ID: {}&quot;, id);</span>
        
<span class="fc bfc" id="L89" title="All 4 branches covered.">        if (id == null || id.trim().isEmpty()) {</span>
<span class="fc" id="L90">            throw new IllegalArgumentException(&quot;Quote ID cannot be null or empty&quot;);</span>
        }
        
        try {
<span class="fc" id="L94">            Quote quote = quoteRepository.findById(id)</span>
<span class="fc" id="L95">                    .orElseThrow(() -&gt; new QuoteNotFoundException(&quot;Quote not found with ID: &quot; + id));</span>
            
<span class="fc" id="L97">            QuoteResponseDto response = buildQuoteResponseFromEntity(quote);</span>
            
<span class="fc" id="L99">            log.debug(&quot;Quote retrieved successfully for ID: {}&quot;, id);</span>
<span class="fc" id="L100">            return response;</span>
            
<span class="fc" id="L102">        } catch (QuoteNotFoundException ex) {</span>
<span class="fc" id="L103">            log.warn(&quot;Quote not found for ID: {}&quot;, id);</span>
<span class="fc" id="L104">            throw ex;</span>
<span class="fc" id="L105">        } catch (Exception ex) {</span>
<span class="fc" id="L106">            log.error(&quot;Failed to retrieve quote with ID: {}. Error: {}&quot;, id, ex.getMessage(), ex);</span>
<span class="fc" id="L107">            throw ex;</span>
        }
    }

    @Override
    public BigDecimal calculatePremium(QuoteRequestDto request) {
<span class="fc" id="L113">        log.info(&quot;Starting premium calculation&quot;);</span>
        
<span class="fc bfc" id="L115" title="All 2 branches covered.">        if (request == null) {</span>
<span class="fc" id="L116">            throw new IllegalArgumentException(&quot;Quote request cannot be null&quot;);</span>
        }
        
        // Validate request
<span class="fc" id="L120">        validationService.validateQuoteRequest(request);</span>
        
        try {
<span class="fc" id="L123">            BigDecimal premium = riskCalculationService.calculateBasePremium(request);</span>
            
<span class="fc" id="L125">            log.debug(&quot;Premium calculation completed successfully for VIN: {}, amount: {}&quot;, </span>
<span class="fc" id="L126">                     request.getVehicle().getVin(), premium);</span>
            
<span class="fc" id="L128">            return premium;</span>
            
<span class="fc" id="L130">        } catch (Exception ex) {</span>
<span class="fc" id="L131">            log.error(&quot;Failed to calculate premium for VIN: {}. Error: {}&quot;, </span>
<span class="fc" id="L132">                     request.getVehicle().getVin(), ex.getMessage(), ex);</span>
<span class="fc" id="L133">            throw ex;</span>
        }
    }
    
    /**
     * Extracts the primary driver name from the request for logging purposes.
     */
    private String getPrimaryDriverName(QuoteRequestDto request) {
<span class="pc bpc" id="L141" title="2 of 4 branches missed.">        if (request.getDrivers() == null || request.getDrivers().isEmpty()) {</span>
<span class="nc" id="L142">            return &quot;Unknown&quot;;</span>
        }
        
<span class="fc" id="L145">        var primaryDriver = request.getDrivers().get(0);</span>
<span class="fc" id="L146">        return String.format(&quot;%s %s&quot;, </span>
<span class="fc" id="L147">                            primaryDriver.getFirstName(), </span>
<span class="fc" id="L148">                            primaryDriver.getLastName());</span>
    }
    
    /**
     * Calculates all premium-related components with caching for performance.
     */
    @Cacheable(value = &quot;riskCalculationCache&quot;, key = &quot;#request.vehicle.vin + '-' + #request.drivers.size() + '-' + #request.coverageAmount&quot;)
    private PremiumCalculation calculatePremiumComponents(QuoteRequestDto request) {
<span class="fc" id="L156">        BigDecimal basePremium = riskCalculationService.calculateBasePremium(request);</span>
<span class="fc" id="L157">        BigDecimal discount = discountService.calculateTotalDiscount(request);</span>
<span class="fc" id="L158">        BigDecimal finalPremium = basePremium.subtract(discount);</span>
<span class="fc" id="L159">        BigDecimal monthlyPremium = finalPremium.divide(BigDecimal.valueOf(12), RoundingMode.HALF_UP);</span>
<span class="fc" id="L160">        List&lt;String&gt; appliedDiscounts = discountService.getAppliedDiscounts(request);</span>
        
<span class="fc" id="L162">        return new PremiumCalculation(basePremium, discount, finalPremium, monthlyPremium, appliedDiscounts);</span>
    }
    
    /**
     * Creates a Quote entity from the request and premium calculation using the optimized builder.
     */
    private Quote createQuoteEntity(QuoteRequestDto request, PremiumCalculation premiumCalc) {
<span class="fc" id="L169">        return quoteEntityBuilder.buildQuoteEntity(request, premiumCalc);</span>
    }
    
    /**
     * Builds a QuoteResponseDto from saved quote entity and premium calculation.
     */
    private QuoteResponseDto buildQuoteResponse(Quote savedQuote, PremiumCalculation premiumCalc) {
<span class="fc" id="L176">        return QuoteResponseDto.builder()</span>
<span class="fc" id="L177">                .quoteId(savedQuote.getId())</span>
<span class="fc" id="L178">                .premium(premiumCalc.getFinalPremium())</span>
<span class="fc" id="L179">                .monthlyPremium(premiumCalc.getMonthlyPremium())</span>
<span class="fc" id="L180">                .coverageAmount(savedQuote.getCoverageAmount())</span>
<span class="fc" id="L181">                .deductible(savedQuote.getDeductible())</span>
<span class="fc" id="L182">                .validUntil(savedQuote.getValidUntil())</span>
<span class="fc" id="L183">                .discountsApplied(premiumCalc.getAppliedDiscounts())</span>
<span class="fc" id="L184">                .build();</span>
    }
    
    /**
     * Builds a QuoteResponseDto from a Quote entity (for retrieval operations).
     */
    private QuoteResponseDto buildQuoteResponseFromEntity(Quote quote) {
<span class="fc" id="L191">        return QuoteResponseDto.builder()</span>
<span class="fc" id="L192">                .quoteId(quote.getId())</span>
<span class="fc" id="L193">                .premium(quote.getPremium())</span>
<span class="fc" id="L194">                .monthlyPremium(quote.getMonthlyPremium())</span>
<span class="fc" id="L195">                .coverageAmount(quote.getCoverageAmount())</span>
<span class="fc" id="L196">                .deductible(quote.getDeductible())</span>
<span class="fc" id="L197">                .validUntil(quote.getValidUntil())</span>
<span class="fc" id="L198">                .discountsApplied(quote.getDiscountsApplied())</span>
<span class="fc" id="L199">                .build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>